name: Android CI Signed

on:
  workflow_dispatch:
  push:
    tags:
      - '*'
    branches:
      - master

jobs:
  build-signed:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - name: Read Versions from properties
      id: config
      run: |
        GO_VER=$(grep -E "^de\.felixnuesse\.extract\.goVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        NDK_VER=$(grep -E "^de\.felixnuesse\.extract\.ndkVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        echo "GO_VERSION=$GO_VER" >> $GITHUB_ENV
        echo "NDK_VERSION=$NDK_VER" >> $GITHUB_ENV

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Install NDK
      run: |
        echo "y" | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;${{ env.NDK_VERSION }}"

    # --- PASSAGGI PER LA FIRMA ---

    - name: Decode Keystore
      env:
        ENCODED_STRING: ${{ secrets.APP_KEYSTORE_BASE64 }}
      run: |
        # Decodifica la stringa Base64 in un file reale temporaneo
        echo "$ENCODED_STRING" | base64 --decode > app/release.keystore

    - name: Build Signed Release APK
      env:
        # Passiamo i segreti come variabili d'ambiente che Gradle legger√†
        CMD_RELEASE_KEYSTORE: release.keystore
        CMD_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        CMD_RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        CMD_RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Nota: Usiamo assembleOssRelease invece di assembleOssDebug
        ./gradlew assembleOssRelease --stacktrace

    # --- UPLOAD ---

    - name: Upload Signed APK (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-signed-universal
        # Il percorso cambia da 'debug' a 'release'
        path: app/build/outputs/apk/oss/release/*-oss-universal-release.apk
        if-no-files-found: warn

    - name: Upload Signed APK (Arm64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-signed-arm64
        path: app/build/outputs/apk/oss/release/*-oss-arm64-v8a-release.apk
        if-no-files-found: warn
