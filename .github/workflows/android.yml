name: Android CI Signed

on: 
  workflow_dispatch: # Keep only manual execution

jobs:
  build-signed:
    runs-on: ubuntu-latest
    
    # Make variables available to the entire job
    env:
      APP_KEYSTORE_BASE64: ${{ secrets.APP_KEYSTORE_BASE64 }}
      KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:  ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout sources
      uses:  actions/checkout@v4

    # ...  (Setup for Versions, JDK, Go, Gradle, NDK remain the same) ...
    # (Omitted for brevity, copy what you had before)
    
    # ---------------------------------------------------------
    # FIX BELOW
    # ---------------------------------------------------------

    - name: Decode Keystore
      if: ${{ env.APP_KEYSTORE_BASE64 }} 
      run: |
        # 1. Create the file INSIDE the 'app' folder
        echo "$APP_KEYSTORE_BASE64" | base64 --decode > app/release. keystore

    - name: Build Signed Release APK
      env:
        # 2. Tell Gradle that the file is called 'release. keystore'. 
        # Since build.gradle is inside 'app/', it will look in 'app/release.keystore', where we just placed it.
        CMD_RELEASE_KEYSTORE: release.keystore
        CMD_RELEASE_KEYSTORE_PASSWORD: ${{ env.KEY_STORE_PASSWORD }}
        CMD_RELEASE_KEY_ALIAS: ${{ env.KEY_ALIAS }}
        CMD_RELEASE_KEY_PASSWORD: ${{ env.KEY_PASSWORD }}
      run: |
        ./gradlew assembleOssRelease --stacktrace

    # --- UPLOAD ARTIFACTS (All architectures) ---
    # Note: The upload is for the release build (oss/release)

    - name: Upload APK (Universal)
      uses: actions/upload-artifact@v6
      with: 
        name: round-sync-universal
        path: app/build/outputs/apk/oss/release/*-oss-universal-release.apk
        if-no-files-found: warn

    - name: Upload APK (Arm64)
      uses: actions/upload-artifact@v6
      with:
        name:  round-sync-arm64
        path: app/build/outputs/apk/oss/release/*-oss-arm64-v8a-release.apk
        if-no-files-found: warn

    - name: Upload APK (Armv7)
      uses: actions/upload-artifact@v6
      with: 
        name: round-sync-armeabi
        path: app/build/outputs/apk/oss/release/*-oss-armeabi-v7a-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86)
      uses: actions/upload-artifact@v6
      with:
        name:  round-sync-x86
        path: app/build/outputs/apk/oss/release/*-oss-x86-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86_64)
      uses: actions/upload-artifact@v6
      with:
        name:  round-sync-x64
        path: app/build/outputs/apk/oss/release/*-oss-x86_64-release.apk
        if-no-files-found: warn
