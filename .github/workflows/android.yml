name: Android CI Signed

on:
  workflow_dispatch: # Mantiene solo l'esecuzione manuale

jobs:
  build-signed:
    runs-on: ubuntu-latest
    
    # Rendiamo le variabili disponibili a tutto il job
    env:
      APP_KEYSTORE_BASE64: ${{ secrets.APP_KEYSTORE_BASE64 }}
      KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    # ... (Setup Versioni, JDK, Go, Gradle, NDK rimangono uguali) ...
    # (Ometto per brevità, copia quelli che avevi già)
    
    # ---------------------------------------------------------
    # CORREZIONE QUI SOTTO
    # ---------------------------------------------------------

    - name: Decode Keystore
      if: ${{ env.APP_KEYSTORE_BASE64 }} 
      run: |
        # 1. Creiamo il file DENTRO la cartella 'app'
        echo "$APP_KEYSTORE_BASE64" | base64 --decode > app/release.keystore

    - name: Build Signed Release APK
      env:
        # 2. Diciamo a Gradle che il file si chiama 'release.keystore'.
        # Poiché build.gradle è dentro 'app/', cercherà in 'app/release.keystore', dove lo abbiamo appena messo.
        CMD_RELEASE_KEYSTORE: release.keystore
        CMD_RELEASE_KEYSTORE_PASSWORD: ${{ env.KEY_STORE_PASSWORD }}
        CMD_RELEASE_KEY_ALIAS: ${{ env.KEY_ALIAS }}
        CMD_RELEASE_KEY_PASSWORD: ${{ env.KEY_PASSWORD }}
      run: |
        ./gradlew assembleOssRelease --stacktrace

    # --- UPLOAD ARTIFACTS (Tutte le architetture) ---
    # Nota: L'upload è per la release build (oss/release)

    - name: Upload APK (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-universal
        path: app/build/outputs/apk/oss/release/*-oss-universal-release.apk
        if-no-files-found: warn

    - name: Upload APK (Arm64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-arm64
        path: app/build/outputs/apk/oss/release/*-oss-arm64-v8a-release.apk
        if-no-files-found: warn

    - name: Upload APK (Armv7)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-armeabi
        path: app/build/outputs/apk/oss/release/*-oss-armeabi-v7a-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x86
        path: app/build/outputs/apk/oss/release/*-oss-x86-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86_64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x64
        path: app/build/outputs/apk/oss/release/*-oss-x86_64-release.apk
        if-no-files-found: warn
