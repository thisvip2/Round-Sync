name: Android CI Signed

on:
  workflow_dispatch:
#  push:
#    tags:
#      - '*'
#    branches:
#      - master
#      - main # Aggiunto per compatibilità

jobs:
  build-signed:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - name: Read Versions from properties
      id: config
      run: |
        # Estrae versioni pulendo eventuali spazi bianchi
        GO_VER=$(grep -E "^de\.felixnuesse\.extract\.goVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        NDK_VER=$(grep -E "^de\.felixnuesse\.extract\.ndkVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        
        # Fallback se non trova la versione nel file (sicurezza)
        if [ -z "$GO_VER" ]; then GO_VER="1.25.4"; fi
        
        echo "GO_VERSION=$GO_VER" >> $GITHUB_ENV
        echo "NDK_VERSION=$NDK_VER" >> $GITHUB_ENV
        echo "Detected -> Go: $GO_VER, NDK: $NDK_VER"

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Install NDK
      run: |
        echo "y" | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;${{ env.NDK_VERSION }}"

    # --- DECODIFICA KEYSTORE (Solo se il secret esiste) ---
    - name: Decode Keystore
      if: ${{ secrets.APP_KEYSTORE_BASE64 != '' }}
      env:
        ENCODED_STRING: ${{ secrets.APP_KEYSTORE_BASE64 }}
      run: |
        echo "$ENCODED_STRING" | base64 --decode > app/release.keystore

    # --- BUILD ---
    - name: Build Signed Release APK
      env:
        # Passa i secrets solo se esistono
        CMD_RELEASE_KEYSTORE: release.keystore
        CMD_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        CMD_RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        CMD_RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Esegue la build. Se i secrets mancano, Gradle userà la config locale o fallirà la firma se forzata
        ./gradlew assembleOssRelease --stacktrace

    # --- UPLOAD ARTIFACTS (Tutte le architetture) ---

    - name: Upload APK (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-universal
        path: app/build/outputs/apk/oss/release/*-oss-universal-release.apk
        if-no-files-found: warn

    - name: Upload APK (Arm64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-arm64
        path: app/build/outputs/apk/oss/release/*-oss-arm64-v8a-release.apk
        if-no-files-found: warn

    - name: Upload APK (Armv7)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-armeabi
        path: app/build/outputs/apk/oss/release/*-oss-armeabi-v7a-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x86
        path: app/build/outputs/apk/oss/release/*-oss-x86-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86_64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x64
        path: app/build/outputs/apk/oss/release/*-oss-x86_64-release.apk
        if-no-files-found: warn
